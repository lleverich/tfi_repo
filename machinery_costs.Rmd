---
title: "Machinery COsts"
output: html_document
date: "2024-10-28"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load advocate data}
library(readxl)

advocate = read_excel("C:/Users/LeannaLeverich/The Fertilizer Institute/TFI - Programs/Research/4R/4R Calculator/Leanna's Calculator/DE Inputs.xlsx")
```


```{r load calculator sheets}
#Machinery 
tractors = read_excel("C:/Users/LeannaLeverich/The Fertilizer Institute/TFI - Programs/Research/4R/4R Calculator/Leanna's Calculator/Machinery.xlsx", sheet = 1)

machines = read_excel("C:/Users/LeannaLeverich/The Fertilizer Institute/TFI - Programs/Research/4R/4R Calculator/Leanna's Calculator/Machinery.xlsx", sheet = 2)

implements = read_excel("C:/Users/LeannaLeverich/The Fertilizer Institute/TFI - Programs/Research/4R/4R Calculator/Leanna's Calculator/Machinery.xlsx", sheet = 3)

irrigation = read_excel("C:/Users/LeannaLeverich/The Fertilizer Institute/TFI - Programs/Research/4R/4R Calculator/Leanna's Calculator/Machinery.xlsx", sheet = 4)

#Prices for Diesel
prices = read_excel("C:/Users/LeannaLeverich/The Fertilizer Institute/TFI - Programs/Research/4R/4R Calculator/Leanna's Calculator/FertilizerPrices_Dec2024.xlsx", sheet = 2)

```


# Machinery Costs 

```{r Prepare Data Frame for Machinery Costs}
library(tidyverse)
library(here)


# Clean out empty columns 
df1 <- advocate %>% select(-Mach_purch_price, -Imp_purch_price, -`Water_costs_$.ac-in`, -`Micro_$.ton`, -`other_fert_$.ton`, -`Inhibitor_$.ton`)


# Join implement cost values 
df2 <- df1 %>%
  left_join(implements, by = c("Implement", "Imp_width_ft"))%>%
  select(where(~ !all(is.na(.))))

# Join machine costs values
df3 <- df2 %>%
  left_join(machines, by = c("Machine"), 
            suffix = c("_Imp", "_Mach")) %>% #Imp (for implement) added to original columns 
  select(where(~ !all(is.na(.)))) #Drop columns that are all empty 

# Join tractor cost values
df4 <- df3 %>%
  left_join(tractors, by = c("Tractor_hp"), # Join tractor costs by its HP class 
            suffix = c("_Imp", "_Tract") ) %>% #Imp (for implement) added to original columns 
  select(where(~ !all(is.na(.))))
  
# Join irrigation cost values 
df5 <- df4 %>%
  left_join(irrigation, by = c("Irrigation")) # Do not drop extra columns for calculation of cost as placeholder columns 

```

## Variable Costs 
### Labor Costs 
= labor($/hr) * Per Rate of implement (hr/ac)
1.	Per Rate (hr/ac) = 1/[speed * efficiency * (implement length/8.25)]

ii.	Center Pivot 
= labor($/hr) * labor (hrs/ac-in) * irrigation (ac-in) 

iii.	Drip Irrigation 
= labor($/hr) * labor (hr/application) 

```{r Calculate Labor Costs}
# Cost for labor in $/hr 
labor = 15 

df6 <- df5 %>%
  mutate(LaborCost = case_when(
    is.na(Irrigation) ~ PerRate_hr.ac_Imp * labor,  # If Irrigation is NA
    Irrigation == "Center_pivot" ~  # If Irrigation is "center_pivot"
      labor * `Labor_hrs.ac-in` * `Irr_vol_ac-in`, 
    Irrigation == "Drip_irrigation" & !is.na(Irrigation) ~  # If Irrigation is "drip_irrigation"
      labor * `Labor_hrs/app`, 
    TRUE ~ 0  # Default case if none of the above conditions are met
  ))

```

### Fuel Costs 
i. Tractor + Implement or Self-propelled machine 
= fuel use(gal/hr) * fuel cost * Per Rate of implement (hr/ac) 

ii. Center Pivot  
= fuel($/gal) * fuel (gal/ac-in) * irrigation (ac-in)  

iii. Drip Irrigation  
None 

```{r Fuel}
# fuel cost global variable for irrigation (not sure where it comes from - could use average?)**
fuel_cost2 = 2.75

# Join prices df to get diesel costs for relevant years (3 yr avg)
df7 <- df6 %>%
  left_join(prices %>% select(Year, Diesel), by = "Year")


# Calculate Fuel Costs 
df8 <- df7 %>%
  mutate(FuelCost = case_when(
    is.na(Irrigation) ~ FuelUse_gal.hr * PerRate_hr.ac_Imp * Diesel,  # If Irrigation is NA
    Irrigation == "Center_pivot" ~ fuel_cost2 * `Fuel_gal.ac-in` * `Irr_vol_ac-in`,  # If Irrigation is "center_pivot"
    TRUE ~ 0  # Default case if none of the above conditions are met
  ))
```

### R&M Cost  
i. Tractor + Implement or Self-propelled machine 
= (tractor purchase price * R&M / useful life /annual hours) * Per Rate implement (hr/ac) +  
(Implement purchase price * R&M / useful life / annual house) * Per Rate implement (hr/ac) 

ii. Center Pivot  
= R&M($/ac-in) * irrigation (ac-in)

```{r R&M}
df9 <- df8 %>%
  mutate(RMCost = case_when(
    is.na(Irrigation) ~ ((Mach_purch_price * `RandM_%`/ UsefulLife_yrs_Tract / AnnualUse_hrs) *
                          PerRate_hr.ac_Imp + (Imp_purch_price * `RandM_%_Imp`/
                          UsefulLife_yrs_Imp/AnnualUse_hrs_Imp) * PerRate_hr.ac_Imp), # If Irrigation is NA
    Irrigation == "Center_pivot" ~ `RandM_$.ac-in` * `Irr_vol_ac-in`,  # If Irrigation is "center_pivot"
    TRUE ~ 0)  # Default case if none of the above conditions are met
  )
```

## Ownership Costs 

### Depreciation 
  
i. Machine/Implement  
= (((tractor price – (tractor price * salvage)) / useful life / annual hours) * per rate of implement) +  
((implement price – (implement price * salvage)) / useful life / annual hours * per rate of implement))  

ii. Center Pivot  
= Ownership cost * irrigation (ac-in)  

iii. Drip Irrigation
= ownership cost * length (ft) 

```{r Depreciation}
total_irr_vol = df8$`Irr_vol_ac-in`

df10 <- df9 %>%
  mutate(D_useYrs = UsefulLife_yrs_Tract, D_useYrs_Imp = UsefulLife_yrs_Imp) %>%
  mutate(DeprecCosts = case_when(
    is.na(Irrigation) ~ ((((Mach_purch_price - (Mach_purch_price * `Salvage_%`))/
                           UsefulLife_yrs_Tract / AnnualUse_hrs) * PerRate_hr.ac_Imp) +
      
      
                        (((Imp_purch_price - (Imp_purch_price * `Salvage_%_Imp`)) / 
                           UsefulLife_yrs_Imp / AnnualUse_hrs_Imp) * PerRate_hr.ac_Imp)),  # If Irrigation is NA
    
    
    
    Irrigation == "Center_pivot" ~ `Ownership_$.ac-in` * `Irr_vol_ac-in`,  # If Irrigation is "center_pivot"
    Irrigation == "Drip_irrigation" & !is.na(Irrigation) ~ ((`Ownership_$.ft` * `Imp_width_ft_Imp`) * (`Irr_vol_ac-in`/total_irr_vol)),
    TRUE ~ 0) # Default case if none of the above conditions are met
)
```
### Interest 

i. Machine/Implement 
= (((machinery price+(machinery price * salvage))/2* interest rate / annual hours * per rate of implement) + 
((implement price +(implement price * salvage))/2* interest rate / annual hours * per rate of implement))

ii. Center pivot  
None 

iii. Drip irrigation  
None

```{r Interest}
interest_rate = 0.05

df11 <- df10 %>%
  mutate(InterestCosts = case_when(
    is.na(Irrigation) ~ (((Mach_purch_price + (Mach_purch_price * 
                                             `Salvage_%`))/2*interest_rate/AnnualUse_hrs*PerRate_hr.ac_Imp) +
                        ((Imp_purch_price+(Imp_purch_price*`Salvage_%_Imp`))/2*interest_rate/AnnualUse_hrs_Imp *
                            PerRate_hr.ac_Imp)),
    TRUE ~ 0) # Default case if none of the above conditions are met
)
```

## Total Costs 
```{r Total Variable Costs}
df11 <- df11 %>% 
  mutate(VariableCosts = LaborCost + FuelCost + RMCost) %>%
  mutate(OwnershipCosts = InterestCosts + DeprecCosts) %>%
  mutate(MachineryCosts = VariableCosts + OwnershipCosts) 

inputs1 <- df11 %>%
  select(-c(22:54))

# Save csv
write.csv(inputs1, file = "C:/Users/LeannaLeverich/The Fertilizer Institute/TFI - Programs/Research/4R/4R Calculator/Leanna's Calculator/DE Inputs_MachineCosts.csv", row.names = FALSE)
```

